# Artifacts Module

## Overview

The artifacts module (`/home/user/tiler2-ui/src/features/artifacts/`) provides a sophisticated system for displaying AI-generated content (artifacts) in a separate side panel using React Portals. It enables the AI to create interactive components, visualizations, documents, or any React content that should be displayed alongside the chat interface.

**Purpose**: Enable AI-generated content to be rendered in a dedicated side panel, separate from the conversation thread, using a portal-based architecture that allows content to be defined in one location and rendered in another.

## Directory Structure

```
src/features/artifacts/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ artifact-content.tsx       # Content portal target
â”‚   â”‚   â”œâ”€â”€ artifact-provider.tsx      # Artifact context provider
â”‚   â”‚   â”œâ”€â”€ artifact-slot.tsx          # Portal source component
â”‚   â”‚   â””â”€â”€ artifact-title.tsx         # Title portal target
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ use-artifact.tsx           # Main artifact hook
â”‚   â”‚   â”œâ”€â”€ use-artifact-context.ts    # Context accessor
â”‚   â”‚   â””â”€â”€ use-artifact-open.ts       # Open/close state hook
â”‚   â”œâ”€â”€ context.ts                     # React context definition
â”‚   â”œâ”€â”€ index.tsx                      # Component exports
â”‚   â””â”€â”€ types.ts                       # TypeScript types
â””â”€â”€ index.ts                           # Public API exports
```

## Core Concepts

### Why This Module Exists

1. **Separation of Concerns**: Display AI-generated content separate from chat messages
2. **Portal Architecture**: Use React Portals to render content in different DOM locations
3. **Dynamic Content**: Support any type of React content generated by AI
4. **State Management**: Track which artifact is open and mounted
5. **Context Sharing**: Share data between artifact and its container
6. **Flexible Layout**: Enable side-by-side chat and artifact viewing

### Portal-Based Architecture

The artifacts module uses React Portals to teleport content:

```
AI Message (defines artifact)
        â†“
   ArtifactSlot (source)
        â†“ (portal)
   ArtifactContent (target in side panel)
```

This allows the AI to define content in the message flow while having it render in a completely different part of the UI.

## Key Components

### 1. ArtifactProvider

**File**: `/home/user/tiler2-ui/src/features/artifacts/components/components/artifact-provider.tsx`

The root provider that manages artifact state:

```typescript
export const ArtifactProvider: React.FC<{ children?: ReactNode }> = (props) => {
  const content = useState<HTMLElement | null>(null);
  const title = useState<HTMLElement | null>(null);

  const open = useState<string | null>(null);
  const mounted = useState<string | null>(null);
  const context = useState<Record<string, unknown>>({});

  return (
    <ArtifactSlotContext.Provider
      value={{ open, mounted, title, content, context }}
    >
      {props.children}
    </ArtifactSlotContext.Provider>
  );
};
```

**State Management**:

- `content`: Reference to the DOM element where artifact content should render
- `title`: Reference to the DOM element where artifact title should render
- `open`: ID of the currently open artifact
- `mounted`: ID of the currently mounted artifact
- `context`: Shared context data for the artifact

**Usage**:
```typescript
function App() {
  return (
    <ArtifactProvider>
      <ChatInterface />
      <ArtifactSidePanel />
    </ArtifactProvider>
  );
}
```

### 2. useArtifact Hook

**File**: `/home/user/tiler2-ui/src/features/artifacts/components/hooks/use-artifact.tsx`

The primary hook for creating artifacts in AI-generated components:

```typescript
export const useArtifact = () => {
  const id = useId();
  const context = useContext(ArtifactSlotContext);
  const [ctxOpen, ctxSetOpen] = context.open;
  const [ctxContext, ctxSetContext] = context.context;
  const [, ctxSetMounted] = context.mounted;

  const open = ctxOpen === id;
  const setOpen = useCallback(
    (value: boolean | ((value: boolean) => boolean)) => {
      if (typeof value === "boolean") {
        ctxSetOpen(value ? id : null);
      } else {
        ctxSetOpen((open) => (open === id ? null : id));
      }
      ctxSetMounted(id);
    },
    [ctxSetOpen, ctxSetMounted, id],
  );

  const ArtifactContent = useCallback(
    (props: ArtifactContentProps) => {
      return (
        <ArtifactSlot
          id={id}
          title={props.title}
        >
          {props.children}
        </ArtifactSlot>
      );
    },
    [id],
  );

  return [
    ArtifactContent,
    { open, setOpen, context: ctxContext, setContext: ctxSetContext },
  ] as [
    typeof ArtifactContent,
    {
      open: typeof open;
      setOpen: typeof setOpen;
      context: typeof ctxContext;
      setContext: typeof ctxSetContext;
    },
  ];
};
```

**Returns**:
- `ArtifactContent`: Component to wrap artifact content
- `open`: Whether this artifact is currently open
- `setOpen`: Function to open/close this artifact
- `context`: Shared context data
- `setContext`: Function to update shared context

**Usage in AI-Generated Component**:
```typescript
function MyArtifact() {
  const [ArtifactContent, { open, setOpen }] = useArtifact();

  return (
    <div>
      <button onClick={() => setOpen(true)}>
        Show Chart
      </button>

      <ArtifactContent title="Sales Chart">
        <LineChart data={salesData} />
      </ArtifactContent>
    </div>
  );
}
```

### 3. ArtifactSlot

**File**: `/home/user/tiler2-ui/src/features/artifacts/components/components/artifact-slot.tsx`

Headless component that portals content to the artifact panel:

```typescript
export const ArtifactSlot = (props: ArtifactSlotProps) => {
  const context = useContext(ArtifactSlotContext);

  const [ctxMounted, ctxSetMounted] = context.mounted;
  const [content] = context.content;
  const [title] = context.title;

  const isMounted = ctxMounted === props.id;
  const isEmpty = props.children == null && props.title == null;

  useEffect(() => {
    if (isEmpty) {
      ctxSetMounted((open) => (open === props.id ? null : open));
    }
  }, [isEmpty, ctxSetMounted, props.id]);

  if (!isMounted) return null;
  return (
    <>
      {title != null ? createPortal(<>{props.title}</>, title) : null}
      {content != null ? createPortal(<>{props.children}</>, content) : null}
    </>
  );
};
```

**How It Works**:
1. Checks if this artifact is currently mounted (active)
2. If mounted, creates portals to render title and content
3. Uses `createPortal` to teleport React elements to target DOM nodes
4. Automatically unmounts when content becomes empty

### 4. ArtifactContent

**File**: `/home/user/tiler2-ui/src/features/artifacts/components/components/artifact-content.tsx`

The target container where artifact content is rendered:

```typescript
export function ArtifactContent(props: HTMLAttributes<HTMLDivElement>) {
  const context = useContext(ArtifactSlotContext);

  const [mounted] = context.mounted;
  const ref = useRef<HTMLDivElement>(null);
  const [, setStateRef] = context.content;

  useLayoutEffect(
    () => setStateRef?.(mounted ? ref.current : null),
    [setStateRef, mounted],
  );

  if (!mounted) return null;
  return (
    <div
      {...props}
      ref={ref}
    />
  );
}
```

**How It Works**:
1. Creates a div that will receive portaled content
2. Registers the div ref with the context
3. Only renders when an artifact is mounted
4. The portal from `ArtifactSlot` renders into this div

**Usage in Side Panel**:
```typescript
function ArtifactSidePanel() {
  return (
    <div className="side-panel">
      <ArtifactTitle className="panel-header" />
      <ArtifactContent className="panel-body" />
    </div>
  );
}
```

### 5. ArtifactTitle

**File**: `/home/user/tiler2-ui/src/features/artifacts/components/components/artifact-title.tsx`

Similar to `ArtifactContent` but for the artifact title:

```typescript
export function ArtifactTitle(props: HTMLAttributes<HTMLDivElement>) {
  const context = useContext(ArtifactSlotContext);

  const [mounted] = context.mounted;
  const ref = useRef<HTMLDivElement>(null);
  const [, setStateRef] = context.title;

  useLayoutEffect(
    () => setStateRef?.(mounted ? ref.current : null),
    [setStateRef, mounted],
  );

  if (!mounted) return null;
  return (
    <div
      {...props}
      ref={ref}
    />
  );
}
```

## Types and Interfaces

**File**: `/home/user/tiler2-ui/src/features/artifacts/components/types.ts`

```typescript
export type Setter<T> = (value: T | ((value: T) => T)) => void;

export interface ArtifactSlotContextType {
  open: [string | null, Setter<string | null>];
  mounted: [string | null, Setter<string | null>];
  title: [HTMLElement | null, Setter<HTMLElement | null>];
  content: [HTMLElement | null, Setter<HTMLElement | null>];
  context: [Record<string, unknown>, Setter<Record<string, unknown>>];
}

export interface ArtifactSlotProps {
  id: string;
  children?: ReactNode;
  title?: ReactNode;
}

export interface ArtifactContentProps {
  title?: React.ReactNode;
  children: React.ReactNode;
}
```

## Public API

**File**: `/home/user/tiler2-ui/src/features/artifacts/index.ts`

```typescript
export { ArtifactProvider, useArtifact } from "./components";
```

Minimal public API focusing on the two main exports:
- `ArtifactProvider`: Context provider component
- `useArtifact`: Hook for creating artifacts

## Integration with Other Modules

### Thread Module Integration

Artifacts are displayed alongside thread messages:

```typescript
import { ArtifactProvider, ArtifactContent, ArtifactTitle } from '@/features/artifacts';

function ThreadLayout() {
  return (
    <ArtifactProvider>
      <div className="flex">
        <MessageList />  {/* From thread module */}
        <div className="artifact-panel">
          <ArtifactTitle className="header" />
          <ArtifactContent className="body" />
        </div>
      </div>
    </ArtifactProvider>
  );
}
```

### AI-Generated Components

AI-generated components use the `useArtifact` hook:

```typescript
// AI generates this component dynamically
function DataVisualization({ data }) {
  const [ArtifactContent, { open, setOpen }] = useArtifact();

  return (
    <div className="inline-block">
      <button onClick={() => setOpen(true)}>
        ðŸ“Š View Chart
      </button>

      <ArtifactContent title="Data Visualization">
        <div className="p-4">
          <ResponsiveContainer width="100%" height={400}>
            <BarChart data={data}>
              <Bar dataKey="value" fill="#8884d8" />
            </BarChart>
          </ResponsiveContainer>
        </div>
      </ArtifactContent>
    </div>
  );
}
```

### Side Panel Integration

The side panel module provides the UI container for artifacts:

```typescript
import { ArtifactContent, ArtifactTitle } from '@/features/artifacts';

function ArtifactSidePanel() {
  const { artifactOpen } = useUIContext();

  if (!artifactOpen) return null;

  return (
    <div className="w-96 border-l bg-background">
      <div className="border-b p-4">
        <ArtifactTitle className="text-lg font-semibold" />
      </div>
      <div className="overflow-auto p-4">
        <ArtifactContent />
      </div>
    </div>
  );
}
```

## Common Patterns

### Creating Interactive Artifacts

```typescript
function InteractiveChart() {
  const [ArtifactContent, { open, setOpen, context, setContext }] = useArtifact();
  const [selectedData, setSelectedData] = useState(null);

  // Share data via context
  useEffect(() => {
    if (selectedData) {
      setContext({ selectedData });
    }
  }, [selectedData, setContext]);

  return (
    <div>
      <button onClick={() => setOpen(!open)}>
        {open ? 'Hide' : 'Show'} Chart
      </button>

      <ArtifactContent title="Interactive Sales Chart">
        <div>
          <Chart
            data={salesData}
            onSelect={(data) => setSelectedData(data)}
          />
          {selectedData && (
            <DetailPanel data={selectedData} />
          )}
        </div>
      </ArtifactContent>
    </div>
  );
}
```

### Document Viewer Artifact

```typescript
function DocumentViewer({ documentUrl }) {
  const [ArtifactContent, { setOpen }] = useArtifact();

  useEffect(() => {
    // Auto-open when document loads
    setOpen(true);
  }, [setOpen]);

  return (
    <div>
      <p>I've generated a document for you.</p>

      <ArtifactContent title="Generated Document">
        <iframe
          src={documentUrl}
          className="w-full h-full"
        />
      </ArtifactContent>
    </div>
  );
}
```

### Code Editor Artifact

```typescript
function CodeEditor({ initialCode }) {
  const [ArtifactContent, { open, setOpen }] = useArtifact();
  const [code, setCode] = useState(initialCode);

  return (
    <div>
      <button onClick={() => setOpen(true)}>
        âš¡ Edit Code
      </button>

      <ArtifactContent title="Code Editor">
        <div className="h-full flex flex-col">
          <Editor
            value={code}
            onChange={setCode}
            language="javascript"
          />
          <div className="border-t p-4 flex gap-2">
            <button onClick={() => runCode(code)}>
              Run
            </button>
            <button onClick={() => downloadCode(code)}>
              Download
            </button>
          </div>
        </div>
      </ArtifactContent>
    </div>
  );
}
```

## State Management

### Artifact Lifecycle

1. **Creation**: AI generates component with `useArtifact()` hook
2. **Mounting**: User clicks to open â†’ `setOpen(true)` â†’ artifact mounts
3. **Portal**: `ArtifactSlot` creates portal to `ArtifactContent`
4. **Rendering**: Content appears in side panel
5. **Unmounting**: User closes â†’ `setOpen(false)` â†’ portal removed

### State Flow

```
User Action (setOpen(true))
        â†“
Context Updated (open = artifactId)
        â†“
ArtifactSlot Detects Change
        â†“
Portal Created
        â†“
Content Renders in ArtifactContent
```

## Best Practices

1. **Auto-Open Important Content**: Call `setOpen(true)` in useEffect for critical artifacts
2. **Provide Meaningful Titles**: Always include descriptive titles
3. **Handle Empty States**: Check for data before rendering charts/tables
4. **Cleanup**: Artifacts auto-unmount when source component unmounts
5. **Context for Sharing**: Use context parameter for parent-child communication
6. **Error Boundaries**: Wrap artifact content in error boundaries
7. **Loading States**: Show loading indicators for async content

## Advanced Usage

### Sharing State Between Artifact and Message

```typescript
function SharedStateExample() {
  const [ArtifactContent, { context, setContext }] = useArtifact();
  const [filter, setFilter] = useState('all');

  // Update shared context
  useEffect(() => {
    setContext({ filter });
  }, [filter, setContext]);

  return (
    <div>
      <select value={filter} onChange={(e) => setFilter(e.target.value)}>
        <option value="all">All</option>
        <option value="active">Active</option>
      </select>

      <ArtifactContent title="Filtered Data">
        <DataTable filter={context.filter || 'all'} />
      </ArtifactContent>
    </div>
  );
}
```

### Multiple Artifacts in One Message

```typescript
function MultipleArtifacts() {
  const [Chart1, chart1Controls] = useArtifact();
  const [Chart2, chart2Controls] = useArtifact();

  return (
    <div>
      <button onClick={() => chart1Controls.setOpen(true)}>
        Show Sales Chart
      </button>
      <button onClick={() => chart2Controls.setOpen(true)}>
        Show Revenue Chart
      </button>

      <Chart1 title="Sales">
        <SalesChart />
      </Chart1>

      <Chart2 title="Revenue">
        <RevenueChart />
      </Chart2>
    </div>
  );
}
```

## Performance Considerations

1. **Portal Overhead**: Minimal - React Portals are lightweight
2. **Re-renders**: Only active artifact re-renders
3. **Cleanup**: Automatic when source unmounts
4. **Memory**: One artifact mounted at a time (by default)

## Next Steps

**Next**: [Side Panel Module](/home/user/tiler2-ui/docs/31-module-side-panel.md) - Learn about the side panel UI, thread history, and navigation components that provide the container for artifacts and chat history
