# Artifacts

Artifacts provide a side panel display for code blocks, documents, and other content generated by the AI. This allows users to view generated content alongside the conversation without interrupting the chat flow.

## Why This Exists

When the AI generates substantial content (code, documents, configurations), embedding it inline in the chat can disrupt readability and make it hard to reference while continuing the conversation. Artifacts display this content in a dedicated side panel that users can view, copy, and interact with while maintaining context of the conversation.

## Artifact Types

Artifacts can display various types of content.

**Common Types:**
1. **Code** - Programming code with syntax highlighting
2. **Documents** - Markdown or plain text documents
3. **Configurations** - YAML, JSON, TOML configs
4. **Data** - CSV, tables, structured data
5. **Custom** - Any content with custom rendering

**Type Definition:** `/home/user/tiler2-ui/src/shared/types/index.ts`
```typescript
/**
 * Context for rendering artifacts in the side panel.
 * Contains metadata about the artifact (code, document, etc) being displayed.
 */
export interface ArtifactContext {
  id?: string;
  type?: string;
  title?: string;
  content?: string;
  language?: string;
  [key: string]: unknown;
}
```

## Side Panel Implementation

The artifact side panel is a resizable panel that appears on the right side of the chat.

**Component:** `/home/user/tiler2-ui/src/features/thread/components/layout/artifact-panel.tsx`

**Features:**
- Resizable width (drag handle)
- Collapsible (close button)
- Synchronized with chat messages
- Code syntax highlighting
- Copy to clipboard
- Fullscreen mode (optional)

**Layout Structure:**
```
┌─────────────────────┬──────────────────┐
│                     │                  │
│   Chat Messages     │   Artifact       │
│                     │   Panel          │
│                     │                  │
│   [User message]    │  ┌──────────┐   │
│   [AI response]     │  │ Title    │   │
│   [Code artifact]   │  ├──────────┤   │
│                     │  │          │   │
│                     │  │ Content  │   │
│                     │  │          │   │
└─────────────────────┴──┴──────────┴───┘
```

## ArtifactProvider

The ArtifactProvider manages artifact state using React context.

**File:** `/home/user/tiler2-ui/src/features/artifacts/components/components/artifact-provider.tsx`

**Implementation:**
```typescript
export const ArtifactProvider: React.FC<{ children?: ReactNode }> = (props) => {
  const content = useState<HTMLElement | null>(null);
  const title = useState<HTMLElement | null>(null);

  const open = useState<string | null>(null);      // Currently open artifact ID
  const mounted = useState<string | null>(null);    // Mounted artifact ID
  const context = useState<Record<string, unknown>>({});  // Artifact metadata

  return (
    <ArtifactSlotContext.Provider
      value={{ open, mounted, title, content, context }}
    >
      {props.children}
    </ArtifactSlotContext.Provider>
  );
};
```

**State Management:**
- `open` - ID of currently displayed artifact
- `mounted` - ID of mounted artifact (may differ during transitions)
- `title` - HTML element for artifact title
- `content` - HTML element for artifact content
- `context` - Metadata about current artifact

**Usage:**
```typescript
import { ArtifactProvider } from '@/features/artifacts';

function App() {
  return (
    <ArtifactProvider>
      <ChatInterface />
      <ArtifactPanel />
    </ArtifactProvider>
  );
}
```

## Context Hook

Access artifact state from any component.

**File:** `/home/user/tiler2-ui/src/features/artifacts/components/hooks/use-artifact-context.ts`

**Usage:**
```typescript
import { useArtifactContext } from '@/features/artifacts';

function MyComponent() {
  const {
    open: [openId, setOpenId],
    context: [artifactContext, setArtifactContext],
  } = useArtifactContext();

  // Open artifact
  const openArtifact = (id: string, data: ArtifactContext) => {
    setOpenId(id);
    setArtifactContext(data);
  };

  // Close artifact
  const closeArtifact = () => {
    setOpenId(null);
  };

  return (
    <div>
      {openId && <ArtifactPanel />}
    </div>
  );
}
```

## useArtifact Hook

Higher-level hook for artifact management.

**File:** `/home/user/tiler2-ui/src/features/artifacts/components/hooks/use-artifact.tsx`

**Features:**
- Open/close artifacts
- Set artifact content
- Manage artifact metadata
- Handle transitions

**Example:**
```typescript
import { useArtifact } from '@/features/artifacts';

function CodeBlock({ code, language }: CodeBlockProps) {
  const artifact = useArtifact();

  const handleExpand = () => {
    artifact.open('code-1', {
      type: 'code',
      title: 'Generated Python Script',
      content: code,
      language: language,
    });
  };

  return (
    <div>
      <pre>{code}</pre>
      <button onClick={handleExpand}>
        View in Artifact Panel
      </button>
    </div>
  );
}
```

## useArtifactOpen Hook

Check if an artifact is currently open.

**File:** `/home/user/tiler2-ui/src/features/artifacts/components/hooks/use-artifact-open.ts`

**Usage:**
```typescript
import { useArtifactOpen } from '@/features/artifacts';

function CodeBlock({ id }: CodeBlockProps) {
  const isOpen = useArtifactOpen(id);

  return (
    <div className={cn(
      'code-block',
      isOpen && 'highlight-border'
    )}>
      {/* Content */}
    </div>
  );
}
```

## Resizable Panel

The artifact panel is resizable using a drag handle.

**Implementation:**
```typescript
import { Panel, PanelGroup, PanelResizeHandle } from 'react-resizable-panels';

function ChatLayout() {
  return (
    <PanelGroup direction="horizontal">
      {/* Chat panel */}
      <Panel defaultSize={60} minSize={30}>
        <ChatMessages />
      </Panel>

      {/* Resize handle */}
      <PanelResizeHandle className="w-1 bg-gray-200 hover:bg-blue-400" />

      {/* Artifact panel */}
      <Panel defaultSize={40} minSize={20}>
        <ArtifactPanel />
      </Panel>
    </PanelGroup>
  );
}
```

**Features:**
- Drag to resize
- Minimum/maximum sizes
- Remembers size (localStorage)
- Smooth animations
- Touch-friendly (mobile)

## Code Block Expansion

Code blocks in chat messages can expand to artifact panel.

**Flow:**
1. AI generates code in message
2. Code renders with "Expand" button
3. User clicks "Expand"
4. Code appears in artifact panel
5. Panel opens (if closed)
6. Code synchronized with message

**Example Component:**
```typescript
function CodeBlock({ code, language, id }: CodeBlockProps) {
  const { open } = useArtifact();
  const isOpen = useArtifactOpen(id);

  const handleExpand = () => {
    open(id, {
      type: 'code',
      title: `Code: ${language}`,
      content: code,
      language: language,
    });
  };

  return (
    <div className="relative group">
      <SyntaxHighlighter language={language}>
        {code}
      </SyntaxHighlighter>

      <button
        onClick={handleExpand}
        className={cn(
          'absolute top-2 right-2',
          'opacity-0 group-hover:opacity-100',
          isOpen && 'opacity-100 bg-blue-500'
        )}
      >
        <Maximize2 className="h-4 w-4" />
      </button>
    </div>
  );
}
```

## Artifact Content Component

Renders the artifact content in the panel.

**File:** `/home/user/tiler2-ui/src/features/artifacts/components/components/artifact-content.tsx`

**Props:**
```typescript
export interface ArtifactContentProps {
  title?: React.ReactNode;
  children: React.ReactNode;
}
```

**Usage:**
```typescript
<ArtifactContent title="Generated Code">
  <SyntaxHighlighter language="python">
    {code}
  </SyntaxHighlighter>
</ArtifactContent>
```

**Features:**
- Header with title
- Close button
- Copy button
- Scrollable content
- Fullscreen mode

## Artifact Title Component

Custom title component for artifacts.

**File:** `/home/user/tiler2-ui/src/features/artifacts/components/components/artifact-title.tsx`

**Usage:**
```typescript
<ArtifactTitle>
  <FileCode className="h-4 w-4" />
  <span>Climate Risk Assessment Report</span>
  <Badge variant="secondary">PDF</Badge>
</ArtifactTitle>
```

## Synchronized with Chat Messages

Artifacts stay synchronized with their source messages.

### Message-Artifact Linking

```typescript
// In message component
const artifactId = `artifact-${message.id}`;

<CodeBlock
  id={artifactId}
  code={code}
  language={language}
/>

// Artifact knows its source
const scrollToMessage = () => {
  const messageElement = document.querySelector(
    `[data-message-id="${message.id}"]`
  );
  messageElement?.scrollIntoView({ behavior: 'smooth' });
};
```

### Auto-Close on Message Delete

```typescript
useEffect(() => {
  if (!messageExists && isArtifactOpen) {
    closeArtifact();
  }
}, [messageExists, isArtifactOpen]);
```

### Highlight Active Message

```typescript
const isArtifactSource = useArtifactOpen(artifactId);

<div className={cn(
  'message',
  isArtifactSource && 'ring-2 ring-blue-400'
)}>
```

## Best Practices

### 1. Use Unique IDs

```typescript
// ✅ Good - Unique, stable ID
const artifactId = `artifact-${message.id}-${blockIndex}`;

// ❌ Bad - Non-unique ID
const artifactId = "artifact";
```

### 2. Provide Descriptive Titles

```typescript
// ✅ Good - Specific, helpful
title: "Python script for climate data analysis"

// ❌ Bad - Generic, unhelpful
title: "Code"
```

### 3. Handle Large Content

```typescript
// For very large content, use virtualization
import { VirtualizedList } from '@/components/virtualized-list';

<ArtifactContent title="Large Dataset">
  <VirtualizedList
    items={largeArray}
    itemHeight={30}
  />
</ArtifactContent>
```

### 4. Clean Up on Unmount

```typescript
useEffect(() => {
  return () => {
    if (isOpen) {
      closeArtifact();
    }
  };
}, []);
```

## Common Patterns

### Code Artifact

```typescript
const openCodeArtifact = (code: string, language: string) => {
  artifact.open(`code-${Date.now()}`, {
    type: 'code',
    title: `${language} Code`,
    content: code,
    language: language,
  });
};
```

### Document Artifact

```typescript
const openDocumentArtifact = (content: string) => {
  artifact.open(`doc-${Date.now()}`, {
    type: 'document',
    title: 'Generated Document',
    content: content,
    format: 'markdown',
  });
};
```

### Table Artifact

```typescript
const openTableArtifact = (data: any[]) => {
  artifact.open(`table-${Date.now()}`, {
    type: 'table',
    title: 'Data Table',
    content: data,
    columns: extractColumns(data),
  });
};
```

### Custom Artifact

```typescript
const openCustomArtifact = (component: React.ReactNode) => {
  artifact.open(`custom-${Date.now()}`, {
    type: 'custom',
    title: 'Custom Content',
    component: component,
  });
};
```

## Copy to Clipboard

Artifact content can be copied to clipboard.

**Implementation:**
```typescript
import { useCopyToClipboard } from '@/hooks/use-copy-to-clipboard';

function ArtifactPanel() {
  const { copy, isCopied } = useCopyToClipboard();
  const [artifactContext] = useArtifactContext().context;

  const handleCopy = () => {
    copy(artifactContext.content);
  };

  return (
    <div>
      <button onClick={handleCopy}>
        {isCopied ? (
          <>
            <Check className="h-4 w-4" />
            Copied!
          </>
        ) : (
          <>
            <Copy className="h-4 w-4" />
            Copy
          </>
        )}
      </button>
      {/* Content */}
    </div>
  );
}
```

## Mobile Considerations

On mobile, artifacts display differently.

### Mobile Bottom Sheet

```typescript
import { Sheet, SheetContent } from '@/components/ui/sheet';

function ArtifactPanel() {
  const isMobile = useMediaQuery('(max-width: 768px)');
  const [open, setOpen] = useArtifactContext().open;

  if (isMobile) {
    return (
      <Sheet open={!!open} onOpenChange={() => setOpen(null)}>
        <SheetContent side="bottom">
          <ArtifactContent />
        </SheetContent>
      </Sheet>
    );
  }

  return <div className="artifact-panel">{/* Desktop panel */}</div>;
}
```

### Fullscreen Mode

```typescript
const [isFullscreen, setIsFullscreen] = useState(false);

<div className={cn(
  'artifact-panel',
  isFullscreen && 'fixed inset-0 z-50'
)}>
```

## Accessibility

### Keyboard Navigation

```typescript
// Close on Escape
useEffect(() => {
  const handleKeyDown = (e: KeyboardEvent) => {
    if (e.key === 'Escape' && isOpen) {
      closeArtifact();
    }
  };

  window.addEventListener('keydown', handleKeyDown);
  return () => window.removeEventListener('keydown', handleKeyDown);
}, [isOpen]);
```

### Screen Reader Support

```typescript
<div
  role="complementary"
  aria-label="Artifact panel"
  aria-hidden={!isOpen}
>
  <h2 id="artifact-title">{title}</h2>
  <div aria-labelledby="artifact-title">
    {content}
  </div>
</div>
```

### Focus Management

```typescript
useEffect(() => {
  if (isOpen && panelRef.current) {
    // Focus panel when opened
    panelRef.current.focus();
  }
}, [isOpen]);
```

## Performance Optimization

### Lazy Load Content

```typescript
const ArtifactPanel = lazy(() => import('./artifact-panel'));

{isOpen && (
  <Suspense fallback={<Loading />}>
    <ArtifactPanel />
  </Suspense>
)}
```

### Memoize Content

```typescript
const renderedContent = useMemo(() => {
  if (type === 'code') {
    return <SyntaxHighlighter>{content}</SyntaxHighlighter>;
  }
  if (type === 'markdown') {
    return <Markdown>{content}</Markdown>;
  }
  return <pre>{content}</pre>;
}, [type, content]);
```

### Virtual Scrolling

For large content:
```typescript
import { Virtuoso } from 'react-virtuoso';

<Virtuoso
  data={lines}
  itemContent={(index, line) => (
    <div key={index}>{line}</div>
  )}
/>
```

## Troubleshooting

### Artifact Not Opening

**Check:**
1. ArtifactProvider wraps app
2. Artifact ID is unique
3. Context is set correctly
4. No JavaScript errors

### Content Not Displaying

**Check:**
1. Content is not null/undefined
2. Component renders correctly
3. CSS not hiding content
4. Panel is actually open

### Resize Not Working

**Check:**
1. PanelGroup properly configured
2. Resize handle rendered
3. CSS allows pointer events
4. Min/max sizes not conflicting

## Security Considerations

### Sanitize Content

```typescript
import DOMPurify from 'dompurify';

const sanitizedContent = DOMPurify.sanitize(content);
```

### Code Execution Prevention

```typescript
// Don't use eval() or Function() on artifact content
// Don't render as dangerouslySetInnerHTML without sanitization
```

## Related Documentation

- [Chat System](/home/user/tiler2-ui/docs/08-chat-system.md) - Message rendering
- [State Management](/home/user/tiler2-ui/docs/06-state-management.md) - Context patterns
- [Project Structure](/home/user/tiler2-ui/docs/05-project-structure.md) - Feature organization

---

**Next:** [Keyboard Shortcuts](/home/user/tiler2-ui/docs/14-keyboard-shortcuts.md)
